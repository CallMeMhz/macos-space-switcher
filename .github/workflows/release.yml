name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Build for Apple Silicon
      run: |
        swiftc \
          -o SpaceSwitcherApp_arm64 \
          -target arm64-apple-macosx13.0 \
          -O \
          -framework Cocoa \
          -framework SwiftUI \
          -framework ApplicationServices \
          -parse-as-library \
          SpaceSwitcher/SpaceSwitcherApp.swift
    
    - name: Build for Intel
      run: |
        swiftc \
          -o SpaceSwitcherApp_x86_64 \
          -target x86_64-apple-macosx13.0 \
          -O \
          -framework Cocoa \
          -framework SwiftUI \
          -framework ApplicationServices \
          -parse-as-library \
          SpaceSwitcher/SpaceSwitcherApp.swift
    
    - name: Create Universal Binary
      run: |
        lipo -create SpaceSwitcherApp_arm64 SpaceSwitcherApp_x86_64 -output SpaceSwitcherApp_universal
    
    - name: Create App Bundles
      run: |
        # ARM64 bundle
        mkdir -p SpaceSwitcher-arm64.app/Contents/MacOS
        mkdir -p SpaceSwitcher-arm64.app/Contents/Resources
        cp SpaceSwitcherApp_arm64 SpaceSwitcher-arm64.app/Contents/MacOS/SpaceSwitcher
        cp SpaceSwitcher/Info.plist SpaceSwitcher-arm64.app/Contents/
        codesign --force --deep --sign - SpaceSwitcher-arm64.app
        ditto -c -k --keepParent SpaceSwitcher-arm64.app SpaceSwitcher-arm64.zip
        
        # x86_64 bundle
        mkdir -p SpaceSwitcher-x86_64.app/Contents/MacOS
        mkdir -p SpaceSwitcher-x86_64.app/Contents/Resources
        cp SpaceSwitcherApp_x86_64 SpaceSwitcher-x86_64.app/Contents/MacOS/SpaceSwitcher
        cp SpaceSwitcher/Info.plist SpaceSwitcher-x86_64.app/Contents/
        codesign --force --deep --sign - SpaceSwitcher-x86_64.app
        ditto -c -k --keepParent SpaceSwitcher-x86_64.app SpaceSwitcher-x86_64.zip
        
        # Universal bundle
        mkdir -p SpaceSwitcher-universal.app/Contents/MacOS
        mkdir -p SpaceSwitcher-universal.app/Contents/Resources
        cp SpaceSwitcherApp_universal SpaceSwitcher-universal.app/Contents/MacOS/SpaceSwitcher
        cp SpaceSwitcher/Info.plist SpaceSwitcher-universal.app/Contents/
        codesign --force --deep --sign - SpaceSwitcher-universal.app
        ditto -c -k --keepParent SpaceSwitcher-universal.app SpaceSwitcher-universal.zip
        
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: SpaceSwitcher
        path: |
          SpaceSwitcher-arm64.zip
          SpaceSwitcher-x86_64.zip
          SpaceSwitcher-universal.zip
        
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          SpaceSwitcher-arm64.zip
          SpaceSwitcher-x86_64.zip
          SpaceSwitcher-universal.zip
        body: |
          ## Download
          
          | File | Description |
          |------|-------------|
          | `SpaceSwitcher-universal.zip` | ✅ Recommended - works on both Apple Silicon and Intel |
          | `SpaceSwitcher-arm64.zip` | Apple Silicon (M1/M2/M3/M4) only |
          | `SpaceSwitcher-x86_64.zip` | Intel only |
          
          ## Installation
          
          1. Download and extract the zip file
          2. Move `SpaceSwitcher.app` to `/Applications`
          3. **First launch**: Right-click → Open → Click "Open" to confirm
          4. Grant Accessibility permission when prompted
          
          ## Requirements
          
          - macOS 13.0 or later
          - Enable keyboard shortcuts: System Settings → Keyboard → Keyboard Shortcuts → Mission Control → Enable "Switch to Desktop 1-10"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
